$custom-box-element-separator: "__";
$custom-box-type: null;

@mixin throw-error-if-not-nested($value, $mixin) {
    @if $value == null {
        @error "Usage of the '#{$mixin}' mixin must be nested inside the 'custom-box' mixin";
    }
}

@mixin custom-box($block, $type: checkbox) {
    $custom-box-type: $type !global;

    .#{$block} {
        position: relative;

        @content;
    }
}

@mixin custom-box-input($element: input) {
    @include throw-error-if-not-nested(&, custom-box-input);

    @at-root {
        #{&}#{$custom-box-element-separator + $element} {
            opacity: 0;
            position: absolute;

            @content;
        }
    }
}

@mixin custom-box-label($element: label) {
    @include throw-error-if-not-nested(&, custom-box-label);

    @at-root {
        #{&}#{$custom-box-element-separator + $element} {
            display: inline-flex;
            position: relative;

            &:before {
                background-color: red;
                border: 1px solid black;
                content: '';
                display: block;
                flex: 0 0 1rem;
                height: 1rem;
                margin-right: .5rem;
                min-width: 1rem;

                @if $custom-box-type == radiobox {
                    border-radius: 50%;
                }

                // TODO Add focus styles
            }

            &:after {
                content: '';
                display: none;
                position: absolute;

                @if $custom-box-type == checkbox {
                    border-bottom: 3px solid white;
                    border-right: 3px solid white;
                    height: .5rem;
                    left: .1rem;
                    top: .2rem;
                    transform: rotate(40deg);
                    transform-origin: bottom right;
                    width: .25rem;
                }

                @if $custom-box-type == radiobox {
                    background-color: white;
                    border-radius: 50%;
                    height: .5rem;
                    left: .3rem;
                    top: .3rem;
                    width: .5rem;
                }
            }

            @content;
        }
    }

    @at-root {
        $input: 'input[type="checkbox"]:checked';

        @if $custom-box-type == radiobox {
            $input: 'input[type="radio"]:checked';
        }

        #{&} > #{$input} + #{&}#{$custom-box-element-separator + $element} {
            &:after {
                display: block;
            }
        }
    }
}
